{# * #}
{# * macro - render format #}
{# * #}
{% macro render_format(field_name, field_path, field_schema, field_layout, field_format, is_in_card, show_label=true) %}
{# summary format for display only #}
{% if field_format == 'summary' %}
{% include '__includes/display_summary.html' %}
{# other format or relation #}
{% else %}
{% set format_file = '__includes/input_' ~ field_format ~ '.html' %}
{# form_group_name is a placeholder(@) for relation as it will be replaced by related object's id when posting #}
{# e.g, fieldset.object[name=user] > .form-group[name='@'] > :select, we need to replace @ to id when posting, user.@ -> user.id = xxx  #}
{% set form_group_name = '@' if field_schema.is_relation else field_name %}
<div class="form-group {{ field_schema.type~'-'~field_format }}{{ ' relation' if field_schema.is_relation }}{{ ' row' if view_is_horizontal }}{{ ' d-none' if field_format == 'hidden' }}" name="{{ form_group_name }}">
    {% if show_label %}
    <label class="{{ 'col-auto col-form-label' if view_is_horizontal }}">{{ '<span class="text-danger mr-1">*</span>' if field_schema.required }}{{ field_schema.title }}</label>
    {% endif %}
    {% if view_is_horizontal %}
    <div class="col">
    {% endif %}
{% if exists(format_file) %}
    {% filter right(4) %}{% include format_file %}{% endfilter %}
{% elif field_schema.is_relation %}
    {% filter right(4) %}{% include '__includes/input_relation.html' %}{% endfilter %}
{% else %}
    UNSUPPORTED! {{ format_file }} does not exist!
{% endif %}
    {% if field_schema.description %}
    <small class="mt-2 form-text text-muted">{{ field_schema.description }}</small>
    {% endif %}
    {% if field_format in ['select', 'buttongroup', 'cascader'] %}
    <div class="invalid-feedback">__(Please choose at least one ){{ field_schema.title }}__(!)</div>
    {% elif field_format in ['file', 'image', 'avatar', 'video'] %}
    <div class="invalid-feedback">__(Please upload ){{ field_schema.title }}__(!)</div>
    {% elif field_format in ['switch', 'checkbox'] %}
    {# pass #}
    {% else %}
    <div class="invalid-feedback">__(Invalid ){{ field_schema.title }}__(!)</div>
    {% endif %}
    {% if view_is_horizontal %}
    </div>
    {% endif %}
</div>
{% endif %}
{% endmacro %}
{# * #}
{# * macro - render tab #}
{# * each row will be rendered as a tab #}
{# * #}
{% macro render_tab(field_name, field_path, field_schema, field_layout, field_format, is_in_card) %}
<div class="{{ 'card-header' if is_in_card }}">
    <ul class="nav nav-tabs nav-tabs-lg {{ 'card-header-tabs' if is_in_card }}">
    {% for row in field_layout %}
        {% set tab_column = row[0] %}
        {# use column's title or first column's schema title #}
        {% set tab_schema = field_schema.properties[tab_column['name']] or {} %}
        {% set tab_title = tab_column.params.title if tab_column.params.title else tab_schema.title %}
        <li class="nav-item">
            <a class="nav-link{{ ' active' if loop.first }}" data-toggle="tab" href="#tab-{{ field_name }}-{{ loop.index }}">
                {{ tab_title }}
            </a>
        </li>
    {% endfor %}
    </ul>
</div>
<div class="{{ 'card-body' if is_in_card }}">
    <div class="tab-content">
    {% for row in field_layout %}
        <div class="tab-pane{{ ' active' if loop.first }}" id="tab-{{ field_name }}-{{ loop.index }}">
            {# use [row] as layout to render #}
            {% filter right(12) %}{{ render_layout(field_name, field_path, field_schema, [row], is_in_card) }}{% endfilter %}
        </div>
    {% endfor %}
    </div>
</div>
{% endmacro %}
{# * #}
{# * macro - render layout recrusively #}
{# * NOTE: field_name/field_path/field_schema/field_layout/is_in_card may be used in __includes snippets, can not change their names #}
{# * #}
{% macro render_layout(field_name, field_path, field_schema, field_layout, is_in_card, is_first_level=false) %}
{# NOTE: render_controls is a global var(namespace) defined in {{views}}.html.jinja2, we need to use namespace to set some value in a loop #}
{% set render_controls.column_count = 0 %}
{% for row in field_layout %}
    {% for column in row %}
        {% set render_controls.column_count = render_controls.column_count + 1 %}
    {% endfor %}
{% endfor %}
{# show label logic #}
{# 1. if only one column in layout and is in card, do NOT show label #}
{% set show_label = not (is_in_card and render_controls.column_count == 1) %}
{# per row #}
{% for row in field_layout %}
<div class="row">
{# per column #}
{% for column in row %}
    {% set column_name = column['name'] %}
    {% set column_path = field_path~'.'~column_name %}
    {% set column_schema = field_schema.properties[column_name] or {} %}
    {% set column_layout = column['rows'] %}
    {# column format overwrites schema format #}
    {% set column_format = column.format or column_schema.format %}
    {% set column_class = 'col-lg' if is_first_level else 'col' %}
    {# column wrapper #}
    <div class="{{ (column_class~'-'~column.span|string) if column.span else column_class }}">
    {# blank column #}
    {% if not column_name %}
        {# pass #}
    {# hyphen column #}
    {% elif column_name == '-' %}
        <hr class="mt-3 mb-4">
    {# group column #}
    {% elif column_name|replace('.','')|int(-1) != -1 %}
        <fieldset class="group" name="{{ column_name }}" format="{{ column_format }}">
        {# group card logic #}
        {# 1. group is card by default and do NOT draw cards inside a card #}
        {# 2. if one of its columns is simple field, current group is rendered as card #}
        {% set render_controls.group_has_simple_column = false %}
        {% for r in column_layout %}
            {% for c in r %}
                {% set cn = c['name'] %}
                {% set cs = field_schema.properties[cn] or {} %}
                {# group column #}
                {% if cn|replace('.','')|int(-1) != -1 %}
                    {# group is always rendered as card #}
                {# normal column #}
                {% elif cs %}
                    {% if cs.type == 'object' %}
                        {# ojbect is always rendered as card #}
                    {% elif cs.type == 'array' and cs.format in ['table', 'modal', 'chart', 'media', 'timeline'] %}
                        {# NOTE: only above complex formats will be rendered as card #}
                    {% else %}
                        {% set render_controls.group_has_simple_column = true %}
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% endfor %}
        {% set group_is_card = not is_in_card and render_controls.group_has_simple_column %}
        {% set group_title = column.params.title %}
        {% set group_icon = column.params.icon or field_schema.icon %}
        {# tab/summary formats has special card-body logic, do not create card-body #}
        {% set group_has_body = false if column_format in ['tab', 'summary'] else true %}
        {% if group_is_card %}
            <div class="card">{% if group_title %}<div class="card-header"><h4 class="card-header-title">{% if group_icon %}<i class="fe fe-{{ group_icon }} mr-2"></i>{% endif %}{{ group_title }}</h4></div>{% endif %}{% if group_has_body %}<div class="card-body">{% endif +%}
        {% endif %}
        {# tab format #}
        {% if column_format == 'tab' %}
            {% filter right(12) %}{{ render_tab(field_name, field_path, field_schema, column_layout, column_format, group_is_card) }}{% endfilter %}
        {# w/ format, i.e, summary #}
        {% elif column_format %}
            {% filter right(12) %}{{ render_format(field_name, field_path, field_schema, column_layout, column_format, group_is_card) }}{% endfilter %}
        {# w/o format #}
        {% else %}
            {% filter right(12) %}{{ render_layout(field_name, field_path, field_schema, column_layout, group_is_card) }}{% endfilter %}
        {% endif %}
        {% if group_is_card %}
            {%+ if group_has_body %}</div>{% endif %}</div>
        {% endif %}
        </fieldset>
    {# make sure column_schema is valid #}
    {% elif not column_schema %}
        UNSUPPORTED! invalid column name: {{ column_name }}!
    {# non-editable column #}
    {# NOTE: back relation is non editable, just display #}
    {% elif not column_schema.editable %}
        {% filter right(8) %}{{ display_field(column_name, column_path, column_schema, column_layout, column_format, is_in_card) }}{% endfilter %}
    {# object column #}
    {% elif column_schema.type == 'object' %}
        <fieldset class="object{{ ' relation' if column_schema.is_relation }}" name="{{ column_name }}" format="{{ column_format }}">
        {# object card logic #}
        {# 1. object is card by default and do NOT draw cards inside a card #}
        {% set object_is_card = not is_in_card %}
        {% set object_show_label = true %}
        {# summary format has special card-body logic, do not create card-body #}
        {% set object_has_body = false if column_format in ['summary'] else true %}
        {% if object_is_card %}
            <div class="card"><div class="card-header"><h4 class="card-header-title">{% if column_schema.icon %}<i class="fe fe-{{ column_schema.icon }} mr-2"></i>{% endif %}{{ column_schema.title }}</h4></div>{% if object_has_body %}<div class="card-body">{% endif +%}
            {% set object_show_label = false %}
        {% else %}
            {% set object_show_label = show_label %}
        {% endif %}
        {# w/ format or relation #}
        {% if column_format or column_schema.is_relation %}
            {% filter right(12) %}{{ render_format(column_name, column_path, column_schema, column_layout, column_format, object_is_card, object_show_label) }}{% endfilter %}
        {# w/o format #}
        {% else %}
            {{ '{%' }} set {{ column_name }} = {{ column_path }} {{ '%}' }}
            {% filter right(12) %}{{ render_layout(column_name, column_name, column_schema, column_layout, object_is_card) }}{% endfilter %}
        {% endif %}
        {% if object_is_card %}
            {%+ if object_has_body %}</div>{% endif %}</div>
        {% endif %}
        </fieldset>
    {# array column #}
    {% elif column_schema.type == 'array' %}
        <fieldset class="array{{ ' relation' if column_schema.is_relation }}" name="{{ column_name }}" format="{{ column_format }}">
        {# array card logic #}
        {# 1. array in formats(table/modal/chart/media/timeline) is card by default and do NOT draw cards inside a card #}
        {% set array_is_card = not is_in_card and column_format in ['table', 'modal', 'chart', 'media', 'timeline'] %}
        {% set array_show_label = true %}
        {# below formats use .table-responsive(w/o x-padding) instead of .card-body #}
        {% set array_card_body_class = 'table-responsive' if column_format in ['table', 'modal', 'chart'] else 'card-body' %}
        {% if array_is_card %}
            <div class="card"><div class="card-header"><h4 class="card-header-title">{% if column_schema.icon %}<i class="fe fe-{{ column_schema.icon }} mr-2"></i>{% endif %}{{ column_schema.title }}</h4></div><div class="{{ array_card_body_class }}">
            {% set array_show_label = false %}
        {% else %}
            {% set array_show_label = show_label %}
        {% endif %}
        {# w/ format or relation #}
        {% if column_format or column_schema.is_relation %}
            {% filter right(12) %}{{ render_format(column_name, column_path, column_schema, column_layout, column_format, array_is_card, array_show_label) }}{% endfilter %}
        {# w/o format #}
        {% else %}
            {% set item_schema = column_schema['items'] %}
            <div class="array-items">
                {{ '{%' }} for {{ column_name }}_item in {{ column_path }} + [new_model('{{ item_schema.py_type }}')] {{ '%}' }}
                <div class="array-item{{ '{{' }} ' template' if loop.last {{ '}}' }}" name="-" format="{{ item_schema.format }}">
                    <div class="row">
                        <div class="col">
                        {# simple types always have a format, this also handle objects that have format #}
                        {% if item_schema.format %}
                            {% filter right(28) %}{{ render_format('-', column_name~'_item', item_schema, column_layout, array_is_card, array_show_label) }}{% endfilter %}
                        {% elif item_schema.type == 'object' %}
                            {% filter right(28) %}{{ render_layout('-', column_name~'_item', item_schema, column_layout, array_is_card) }}{% endfilter %}
                        {% else %}
                            UNSUPPORTED! {{ item_schema.type }} with format {{ item_schema.format }} can not in an array!
                        {% endif %}
                        </div>
                        <div class="col-auto pl-0">
                            <a href="javascript:;" class="text-muted" onclick="array_action_delete($(this));" data-title="{{ item_schema.title }}">
                                <i class="fe fe-x-circle"></i>
                            </a>
                        </div>
                    </div>
                </div>
                {{ '{%' }} endfor {{ '%}' }}
                <div class="array-item p-0" style="{{ '{{' }} 'display:none' if {{ column_path }}  {{ '}}' }}"><div class="alert alert-light mb-4"><i class="fe fe-alert-circle mr-2"></i>__(No ){{ item_schema.title }}!</div></div>
            </div>
            <div class="array-actions mb-4">
                <a class="btn btn-outline-primary mr-2" onclick="array_action_add($(this));"><i class="fe fe-plus mr-1"></i>__(Add ){{ item_schema.title }}</a>
            </div>
        {% endif %}
        {% if array_is_card %}
            </div></div>
        {% endif %}
        </fieldset>
    {# simple column, always having a format #}
    {% else %}
        {% filter right(8) %}{{ render_format(column_name, column_path, column_schema, column_layout, column_format, is_in_card, show_label) }}{% endfilter %}
    {% endif %}
    </div>
{% endfor %}
</div>
{% endfor %}
{% endmacro %}
{# * #}
{# * main #}
{# * #}
<div id="div-{{ view.name_kebab }}">
    <form id="{{ view.name_kebab }}" class="form-editor needs-validation" novalidate method="post">
        <fieldset class="object" name="{{ model.name_snake }}">
            {% if view_is_card %}
            <div class="card"><div class="card-body">
            {% endif %}
            {% filter right(12) %}{{ render_layout(model.name_snake, model.name_snake, model.schema, view.rows, view_is_card, true) }}{% endfilter %}
            {% if view_is_card %}
            </div></div>
            {% endif %}
        </fieldset>
    </form>
    <div class="form-actions mb-4">
        <a class="btn btn-primary mr-2" onclick="{{ view.name_snake }}_{{ action }}($(this));"><i class="fe fe-save mr-1"></i>__(Save)</a>
        {% set target_url = generate_url(model.schema.py_type, model.name_snake, ['read', 'query']) %}
        {% if target_url != 'javascript:;' %}
        {{ '{%' }} if {{ model.name_snake }}.{{ model.schema.id_name }} {{ '%}' }}
        <a href="{{ target_url }}" class="btn btn-outline-primary mr-2"><i class="fe fe-corner-up-left mr-1"></i>__(Cancel)</a>
        {{ '{%' }} endif {{ '%}' }}
        {% endif %}
    </div>
</div>
